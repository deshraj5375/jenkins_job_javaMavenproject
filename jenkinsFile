node()
{

mvn=tool 'm3'
stage('checkout')
{
    sh 'rm -rf *'
    checkout scm
}

stage('Complie and package')
{
 sh 'mvn clean package'
}

stage('build docker file')
{

sh '''
 mkdir dockerimage
 cd dockerimage
 cp $WORKSPACE/target/*.jar .
 cp $WORKSPACE/Dockerfile .
 echo "Building image"
 #docker build -t app:$BUILD_NUMBER . 
 dockerImage = docker.build(app:$BUILD_NUMBER)

 '''

}

stage('image uplaoding to hub')
{

    docker.withRegistry('', 'docker-hub') {
                        dockerImage.push()
                        dockerImage.push('latest') }
    
}

stage('Deploying image')
{
    sh ' docker run -d -p 5000:8080 --name testDesh app:$BUILD_NUMBER '
}

}